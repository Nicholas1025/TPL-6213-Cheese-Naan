<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Todo CRUD Application</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" crossorigin="anonymous">

    <style>
        body {
            background-color: #f8f9fa;
        }

        #todoLabel {
            font-weight: bold;
            font-size: 50px;
            padding: 5px;
            border-radius: 5px;
        }

        .list-group-item {
            border: 1px solid #007bff;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .completed {
            text-decoration: line-through;
            background-color: #d4edda;
        }

        .back-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
        }

        @media (min-aspect-ratio: 16/9) {
            .back-video {
                width: 100%;
                height: auto;
            }
        }

        @media (max-aspect-ratio: 16/9) {
            .back-video {
                width: auto;
                height: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container mt-5">

        <!-- Background Video -->
        <video autoplay loop muted plays-inline class="back-video">
            <source src="http://localhost:3000/video/video.mp4" type="video/mp4">
        </video>

        <!-- Add Todo Form -->
        <div class="row">
            <div class="col-md-6 offset-md-3">
                <form id="todoForm">
                    <div class="form-group">
                        <label for="todoInput" id="todoLabel">New Todo</label>
                        <input type="text" class="form-control" id="todoInput" placeholder="Enter a new todo item" required>
                    </div>
                    <div class="form-group">
                        <label for="priorityInput">Priority</label>
                        <select id="priorityInput" class="form-control">
                            <option value="high">High</option>
                            <option value="medium" selected>Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Add Todo</button>
                </form>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mt-4">
            <div class="col-md-6 offset-md-3">
                <input type="text" id="searchInput" class="form-control mb-2" placeholder="Search tasks...">
                <select id="filterStatus" class="form-select mb-3">
                    <option value="all">All</option>
                    <option value="pending">Pending</option>
                    <option value="completed">Completed</option>
                </select>
                <select id="filterPriority" class="form-select mb-3">
                    <option value="all">All Priorities</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
        </div>

        <!-- Todo List -->
        <div class="row mt-4">
            <div class="col-md-6 offset-md-3">
                <ul class="list-group" id="todoList"></ul>
            </div>
        </div>

        <!-- Alert Messages -->
        <div class="row mt-3">
            <div class="col-md-6 offset-md-3">
                <div class="alert alert-dismissible fade show" role="alert" id="alertMessage" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script>
       $(document).ready(function () {
    const todoList = $("#todoList");
    const todoForm = $("#todoForm");
    const todoInput = $("#todoInput");
    const priorityInput = $("#priorityInput");
    const alertMessage = $("#alertMessage");
    const filterStatus = $("#filterStatus");
    const filterPriority = $("#filterPriority");
    const searchInput = $("#searchInput");
    let todos = [];

    const showAlert = (message, type = "success") => {
        alertMessage
            .removeClass("alert-success alert-danger")
            .addClass(`alert-${type}`)
            .text(message)
            .fadeIn();

        setTimeout(() => {
            alertMessage.fadeOut();
        }, 3000);
    };

    const fetchTodos = async () => {
        try {
            const response = await fetch('/getTodos');
            todos = await response.json();
            renderTodos(todos);
        } catch (err) {
            console.error("Error fetching todos:", err);
        }
    };

    const renderTodos = (filteredTodos) => {
        todoList.empty();
        filteredTodos.forEach(todo => {
            const statusBtnLabel = todo.status === "completed" ? "Undo" : "Complete";
            const completedClass = todo.status === "completed" ? "completed" : "";
            const priorityClass = todo.priority === "high" ? "badge-danger" :
                                  todo.priority === "medium" ? "badge-warning" : "badge-success";

            const todoItem = `
                <li class="list-group-item d-flex justify-content-between align-items-center ${completedClass}" id="todo-${todo._id}">
                    <span>${todo.todo} <span class="badge ${priorityClass}">${todo.priority}</span></span>
                    <div>
                        <button class="btn btn-success btn-sm status-btn" data-id="${todo._id}" data-status="${todo.status}">${statusBtnLabel}</button>
                        <button class="btn btn-danger btn-sm delete-btn" data-id="${todo._id}">Delete</button>
                    </div>
                </li>`;
            todoList.append(todoItem);
        });
    };

    const addTodo = async (todoText, priority) => {
        try {
            const response = await fetch('/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ todo: todoText, priority })
            });
            if (response.ok) {
                fetchTodos();
            }
        } catch (err) {
            console.error("Error adding todo:", err);
        }
    };

    const updateStatus = async (id, status) => {
        try {
            await fetch(`/updateStatus/${id}`, {
                method: "PUT",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            fetchTodos();
        } catch (err) {
            console.error("Error updating status:", err);
        }
    };

    const deleteTodo = async (id) => {
        try {
            const response = await fetch(`/${id}`, { method: 'DELETE' });
            if (response.ok) {
                fetchTodos();
            } else {
                console.error("Failed to delete todo:", response.status);
            }
        } catch (err) {
            console.error("Error deleting todo:", err);
        }
    };

    todoForm.submit((e) => {
        e.preventDefault();
        addTodo(todoInput.val().trim(), priorityInput.val());
        todoInput.val("");
    });

    todoList.on("click", ".status-btn", function () {
        const id = $(this).data("id");
        const status = $(this).data("status") === "pending" ? "completed" : "pending";
        updateStatus(id, status);
    });

    todoList.on("click", ".delete-btn", function () {
        const id = $(this).data("id");
        deleteTodo(id);
    });

    filterStatus.on("change", function () {
        const status = $(this).val();
        const priority = filterPriority.val();
        filterAndRender(status, priority, searchInput.val().toLowerCase());
    });

    filterPriority.on("change", function () {
        const status = filterStatus.val();
        const priority = $(this).val();
        filterAndRender(status, priority, searchInput.val().toLowerCase());
    });

    searchInput.on("input", function () {
        const query = $(this).val().toLowerCase();
        const status = filterStatus.val();
        const priority = filterPriority.val();
        filterAndRender(status, priority, query);
    });

    const filterAndRender = (status, priority, query) => {
        let filteredTodos = todos;

        if (status !== "all") {
            filteredTodos = filteredTodos.filter(todo => todo.status === status);
        }

        if (priority !== "all") {
            filteredTodos = filteredTodos.filter(todo => todo.priority === priority);
        }

        if (query) {
            filteredTodos = filteredTodos.filter(todo =>
                todo.todo.toLowerCase().includes(query)
            );
        }

        renderTodos(filteredTodos);
    };

    fetchTodos();
});

    </script>
</body>
</html>
