<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Todo List - Modern Design</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
  <style type="text/css">
    @import url('https://fonts.googleapis.com/css?family=Gochi+Hand');

    body {
      background-color: #a39bd2;
      min-height: 100vh;
      padding: 1rem;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: center;
      color: hsl(198, 1%, 29%);
      font-family: 'Gochi Hand', cursive;
      text-align: center;
      font-size: 130%;
    }

    .container {
      width: 100%;
      height: auto;
      min-height: 500px;
      max-width: 500px;
      min-width: 250px;
      background: #f1f5f8;
      background-image: radial-gradient(#bfc0c1 7.2%, transparent 0);
      background-size: 25px 25px;
      border-radius: 20px;
      box-shadow: 4px 3px 7px 2px #00000040;
      padding: 1rem;
      box-sizing: border-box;
    }

    .heading {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .heading__title {
      transform: rotate(2deg);
      padding: 0.2rem 1.2rem;
      border-radius: 20% 5% 20% 5%/5% 20% 25% 20%;
      background-color: hsla(166, 100%, 50%, 0.7);
      font-size: 1.5rem;
    }

    .form__label {
      display: block;
      margin-bottom: 0.5rem;
    }

    .form__input {
      box-sizing: border-box;
      background-color: transparent;
      padding: 0.7rem;
      border-bottom-right-radius: 15px 3px;
      border-bottom-left-radius: 3px 15px;
      border: solid 3px transparent;
      border-bottom: dashed 3px #ea95e0;
      font-family: 'Gochi Hand', cursive;
      font-size: 1rem;
      color: hsla(260, 2%, 25%, 0.7);
      width: 70%;
      margin-bottom: 20px;
    }

    .form__input:focus {
      outline: none;
      border: solid 3px #ea95e0;
    }

    .button {
      padding: 0;
      border: none;
      transform: rotate(4deg);
      font-family: 'Gochi Hand', cursive;
      text-decoration: none;
      padding-bottom: 3px;
      border-radius: 5px;
      box-shadow: 0 2px 0 hsl(198, 1%, 29%);
      transition: all 0.3s;
      background-color: hsla(166, 100%, 50%, 0.7);
    }

    .button span {
      background: #f1f5f8;
      display: block;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      border: 2px solid hsl(198, 1%, 29%);
    }

    .toDoList li {
      position: relative;
      padding: 0.5rem;
    }

    .toDoList li:hover {
      text-decoration: line-through wavy #24bffb;
    }
  </style>
</head>
<body>
  <video autoplay loop muted plays-inline class="back-video">
    <source src="/video/video.mp4" type="video/mp4">
  </video>

  <div class="container mt-5">
    <div class="heading">
      <h1 class="heading__title">To-Do List</h1>
    </div>
    <form id="todoForm">
      <div class="form-group">
        <label for="todoInput" class="form__label">~ Today I need to ~</label>
        <input type="text" class="form__input" id="todoInput" placeholder="Enter a new task" required>
        <select id="priorityInput" class="form-control">
          <option value="high">High</option>
          <option value="medium" selected>Medium</option>
          <option value="low">Low</option>
        </select>
        <button type="submit" class="button"><span>Add Task</span></button>
      </div>
    </form>

    <div class="mt-4">
      <input type="text" id="searchInput" class="form-control mb-2" placeholder="Search tasks...">
      <select id="filterStatus" class="form-select mb-3">
        <option value="all">All</option>
        <option value="pending">Pending</option>
        <option value="completed">Completed</option>
      </select>
      <select id="filterPriority" class="form-select mb-3">
        <option value="all">All Priorities</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>
    </div>

    <div class="mt-4">
      <h3 class="text-center">Todo List</h3>
      <ul class="list-group" id="todoList"></ul>
    </div>

    <div class="mt-3">
      <div class="alert alert-dismissible fade show" role="alert" id="alertMessage" style="display: none;"></div>
    </div>
  </div>

  <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function () {
      const todoList = $("#todoList");
      const todoForm = $("#todoForm");
      const todoInput = $("#todoInput");
      const priorityInput = $("#priorityInput");
      const alertMessage = $("#alertMessage");
      const filterStatus = $("#filterStatus");
      const filterPriority = $("#filterPriority");
      const searchInput = $("#searchInput");
      let todos = [];

      const showAlert = (message, type = "success") => {
        alertMessage
          .removeClass("alert-success alert-danger")
          .addClass(`alert-${type}`)
          .text(message)
          .fadeIn();

        setTimeout(() => {
          alertMessage.fadeOut();
        }, 3000);
      };

      const fetchTodos = async () => {
        try {
          const response = await fetch('/getTodos');
          todos = await response.json();
          renderTodos(todos);
        } catch (err) {
          console.error("Error fetching todos:", err);
        }
      };

      const renderTodos = (filteredTodos) => {
        todoList.empty();
        filteredTodos.forEach(todo => {
          const statusBtnLabel = todo.status === "completed" ? "Undo" : "Complete";
          const completedClass = todo.status === "completed" ? "completed" : "";
          const priorityClass = todo.priority === "high" ? "badge-danger" :
                                todo.priority === "medium" ? "badge-warning" : "badge-success";

          const todoItem = `
          <li class="list-group-item d-flex justify-content-between align-items-center ${completedClass}" id="todo-${todo._id}">
              <span>${todo.todo} <span class="badge ${priorityClass}">${todo.priority}</span></span>
              <div>
              <button class="btn btn-success btn-sm status-btn" data-id="${todo._id}" data-status="${todo.status}">${statusBtnLabel}</button>
              <button class="btn btn-danger btn-sm delete-btn" data-id="${todo._id}">Delete</button>
              </div>
          </li>`;
          
          todoList.append(todoItem);
        });
      };

      const addTodo = async (todoText, priority) => {
        try {
          const response = await fetch('/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ todo: todoText, priority })
          });
          if (response.ok) {
            fetchTodos();
          }
        } catch (err) {
          console.error("Error adding todo:", err);
        }
      };

      const deleteTodo = async (id) => {
        try {
          const response = await fetch(`/${id}`, {
            method: "DELETE",
          });
          if (response.ok) {
            showAlert("Todo deleted successfully!", "success");
            fetchTodos();
          } else {
            showAlert("Failed to delete todo", "danger");
          }
        } catch (err) {
          console.error("Error deleting todo:", err);
          showAlert("Error deleting todo", "danger");
        }
      };

      const updateStatus = async (id, status) => {
        try {
            await fetch(`/updateStatus/${id}`, {
            method: "PUT",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
            });
            fetchTodos();
        } catch (err) {
            console.error("Error updating status:", err);
        }
      };

      const filterAndRender = (status, priority, query) => {
        let filteredTodos = todos;

        if (status !== "all") {
          filteredTodos = filteredTodos.filter(todo => todo.status === status);
        }

        if (priority !== "all") {
          filteredTodos = filteredTodos.filter(todo => todo.priority === priority);
        }

        if (query) {
          filteredTodos = filteredTodos.filter(todo =>
            todo.todo.toLowerCase().includes(query)
          );
        }

        renderTodos(filteredTodos);
      };

      todoForm.on("submit", (e) => {
        e.preventDefault();
        addTodo(todoInput.val().trim(), priorityInput.val());
        todoInput.val("");
      });

      todoList.on("click", ".delete-btn", function () {
        const id = $(this).data("id");
        deleteTodo(id);
      });

      todoList.on("click", ".status-btn", function () {
        const id = $(this).data("id");
        const status = $(this).data("status") === "pending" ? "completed" : "pending";
        updateStatus(id, status);
      });

      filterStatus.on("change", function () {
        const status = $(this).val();
        const priority = filterPriority.val();
        filterAndRender(status, priority, searchInput.val().toLowerCase());
      });

      filterPriority.on("change", function () {
        const status = filterStatus.val();
        const priority = $(this).val();
        filterAndRender(status, priority, searchInput.val().toLowerCase());
      });

      searchInput.on("input", function () {
        const query = $(this).val().toLowerCase();
        const status = filterStatus.val();
        const priority = filterPriority.val();
        filterAndRender(status, priority, query);
      });

      fetchTodos();
    });
  </script>
</body>
</html>
