<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Todo List with jQuery UI Sortable</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
  <style type="text/css">
    body {
      color: #fff;
      font-family: Helvetica, sans-serif;
      font-size: 20px;
      margin: 0;
      padding: 0;
      height: 100vh;
    }

    .back-video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }

    @media (min-aspect-ratio: 16/9) {
      .back-video {
        width: 100%;
        height: auto;
      }
    }

    @media (max-aspect-ratio: 16/9) {
      .back-video {
        width: auto;
        height: 100%;
      }
    }

    .container {
      position: relative;
      z-index: 1;
      height: 90vh;
    }

    li {
      padding: 10px;
      margin: 10px;
      list-style: none;
      border-radius: 3px;
      background-color: rgba(0, 0, 0, 0.7);
      color: #000000;
      align-items: center;
      opacity: 0.85;
    }

    .ui-sortable-placeholder {
      visibility: visible !important;
      border: 2px dashed #000;
    }

    .completed {
      text-decoration: line-through;
      background-color: rgba(0, 255, 0, 0.3);
    }

    .alert {
      z-index: 1;
    }
  </style>
</head>
<body>
  <video autoplay loop muted plays-inline class="back-video">
    <source src="/video/video.mp4" type="video/mp4">
  </video>

  <div class="container mt-5">
    <div class="row">
      <div class="col-md-6 offset-md-3">
        <form id="todoForm">
          <div class="form-group">
            <label for="todoInput" id="todoLabel" style="font-size: 50px; color: yellow;">New Todo</label>
            <input type="text" class="form-control" id="todoInput" placeholder="Enter a new todo item" required>
          </div>
          <div class="form-group">
            <label for="priorityInput" style="font-size: 30px;">Priority</label>
            <select id="priorityInput" class="form-control">
              <option value="high">High</option>
              <option value="medium" selected>Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary btn-block" style="background-color: #efd97b; opacity: 0.7; color: #000; font-size: larger;">Add Todo</button>
        </form>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-6 offset-md-3">
        <input type="text" id="searchInput" class="form-control mb-2" placeholder="Search tasks...">
        <select id="filterStatus" class="form-select mb-3">
          <option value="all">All</option>
          <option value="pending">Pending</option>
          <option value="completed">Completed</option>
        </select>
        <select id="filterPriority" class="form-select mb-3">
          <option value="all">All Priorities</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-6 offset-md-3">
        <h3 class="text-center">Todo List</h3>
        <ul class="list-group" id="todoList"></ul>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-md-6 offset-md-3">
        <div class="alert alert-dismissible fade show" role="alert" id="alertMessage" style="display: none;"></div>
      </div>
    </div>
  </div>

  <!-- jQuery, jQuery UI, and Lodash -->
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function () {
      const todoList = $("#todoList");
      const todoForm = $("#todoForm");
      const todoInput = $("#todoInput");
      const priorityInput = $("#priorityInput");
      const alertMessage = $("#alertMessage");
      const filterStatus = $("#filterStatus");
      const filterPriority = $("#filterPriority");
      const searchInput = $("#searchInput");
      let todos = [];

      const showAlert = (message, type = "success") => {
        alertMessage
          .removeClass("alert-success alert-danger")
          .addClass(`alert-${type}`)
          .text(message)
          .fadeIn();

        setTimeout(() => {
          alertMessage.fadeOut();
        }, 3000);
      };

      const fetchTodos = async () => {
        try {
          const response = await fetch('/getTodos');
          todos = await response.json();
          renderTodos(todos);
        } catch (err) {
          console.error("Error fetching todos:", err);
        }
      };

      const renderTodos = (filteredTodos) => {
  todoList.empty();
  
  filteredTodos.sort((a, b) => a.position - b.position);

    filteredTodos.forEach(todo => {
        const statusBtnLabel = todo.status === "completed" ? "Undo" : "Complete";
        const completedClass = todo.status === "completed" ? "completed" : "";
        const priorityClass = todo.priority === "high" ? "badge-danger" :
                            todo.priority === "medium" ? "badge-warning" : "badge-success";

        const todoItem = `
        <li class="list-group-item d-flex justify-content-between align-items-center ${completedClass}" id="todo-${todo._id}">
            <span>${todo.todo} <span class="badge ${priorityClass}">${todo.priority}</span></span>
            <div>
            <button class="btn btn-success btn-sm status-btn" data-id="${todo._id}" data-status="${todo.status}">${statusBtnLabel}</button>
            <button class="btn btn-danger btn-sm delete-btn" data-id="${todo._id}">Delete</button>
            </div>
        </li>`;
        
        todoList.append(todoItem);
    });

     todoList.sortable({
        update: function(event, ui) {
            const reorderedTodos = [];
            $("#todoList li").each(function(index) {
                const id = $(this).attr('id').split('-')[1];
                reorderedTodos.push({ _id: id, position: index + 1 });
            });
            fetch('/reorder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reorderedTodos })
            });
        }
    });
};

      const addTodo = async (todoText, priority) => {
        try {
          const response = await fetch('/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ todo: todoText, priority })
          });
          if (response.ok) {
            fetchTodos();
          }
        } catch (err) {
          console.error("Error adding todo:", err);
        }
      };

      const deleteTodo = async (id) => {
        try {
          const response = await fetch(`/${id}`, {
            method: "DELETE",
          });
          if (response.ok) {
            showAlert("Todo deleted successfully!", "success");
            fetchTodos();
          } else {
            showAlert("Failed to delete todo", "danger");
          }
        } catch (err) {
          console.error("Error deleting todo:", err);
          showAlert("Error deleting todo", "danger");
        }
      };

      const updateStatus = async (id, status) => {
        try {
            await fetch(`/updateStatus/${id}`, {
            method: "PUT",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
            });
            fetchTodos();
        } catch (err) {
            console.error("Error updating status:", err);
        }
        };

      const filterAndRender = (status, priority, query) => {
        let filteredTodos = todos;

        if (status !== "all") {
          filteredTodos = filteredTodos.filter(todo => todo.status === status);
        }

        if (priority !== "all") {
          filteredTodos = filteredTodos.filter(todo => todo.priority === priority);
        }

        if (query) {
          filteredTodos = filteredTodos.filter(todo =>
            todo.todo.toLowerCase().includes(query)
          );
        }

        renderTodos(filteredTodos);
      };

      todoForm.on("submit", (e) => {
        e.preventDefault();
        addTodo(todoInput.val().trim(), priorityInput.val());
        todoInput.val("");
      });

      todoList.on("click", ".delete-btn", function () {
        const id = $(this).data("id");
        deleteTodo(id);
      });

      todoList.on("click", ".status-btn", function () {
        const id = $(this).data("id");
        const status = $(this).data("status") === "pending" ? "completed" : "pending";
        updateStatus(id, status);
      });

      filterStatus.on("change", function () {
        const status = $(this).val();
        const priority = filterPriority.val();
        filterAndRender(status, priority, searchInput.val().toLowerCase());
      });

      filterPriority.on("change", function () {
        const status = filterStatus.val();
        const priority = $(this).val();
        filterAndRender(status, priority, searchInput.val().toLowerCase());
      });

      searchInput.on("input", function () {
        const query = $(this).val().toLowerCase();
        const status = filterStatus.val();
        const priority = filterPriority.val();
        filterAndRender(status, priority, query);
      });

      fetchTodos();
    });
  </script>
</body>
</html>
